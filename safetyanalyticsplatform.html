<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Analytics Platform v2.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF9900;
            --primary-dark: #E88700;
            --secondary: #232F3E;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #FF5722;
            --critical: #B71C1C;
            --info: #2196F3;
            --background: #f5f5f5;
            --surface: white;
            --text: #333;
            --text-secondary: #666;
            --border: #ddd;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --chart-bg: white;
        }

        [data-theme="dark"] {
            --background: #1a1a1a;
            --surface: #2d2d2d;
            --text: #e0e0e0;
            --text-secondary: #aaa;
            --border: #444;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
            --chart-bg: #2d2d2d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .header {
            background: var(--secondary);
            color: white;
            padding: 1rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .theme-toggle, .help-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle:hover, .help-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .help-btn {
            background: var(--info);
        }

        .help-btn:hover {
            background: #1976D2;
        }

        .nav-tabs {
            background: var(--surface);
            padding: 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 60px;
            z-index: 90;
        }

        .tabs-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            color: var(--text);
            font-weight: 500;
            position: relative;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(255, 153, 0, 0.1);
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .module-content {
            display: none;
        }

        .module-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-section {
            background: var(--surface);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: rgba(255, 153, 0, 0.05);
            border-color: var(--primary-dark);
        }

        .upload-area.dragover {
            background: rgba(255, 153, 0, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .upload-label:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-change {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        .filter-section {
            background: var(--surface);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--text);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: var(--surface);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-btn {
            background: var(--background);
            border: 1px solid var(--border);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .chart-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .table-container {
            background: var(--surface);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--background);
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: rgba(255, 153, 0, 0.05);
        }

        .severity-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-A { background: var(--critical); color: white; }
        .severity-B { background: var(--danger); color: white; }
        .severity-C { background: var(--warning); color: black; }
        .severity-D { background: var(--success); color: white; }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .status-success {
            background: var(--success);
            color: white;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        .status-warning {
            background: var(--warning);
            color: black;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .help-content {
            display: grid;
            gap: 2rem;
        }

        .help-section {
            background: var(--background);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .help-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .help-section h4 {
            color: var(--text);
            margin: 1rem 0 0.5rem 0;
            font-size: 1rem;
        }

        .help-list {
            list-style: none;
            padding-left: 1rem;
        }

        .help-list li {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .help-list li:before {
            content: "‚ñ∏";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .help-card {
            background: var(--surface);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .help-card strong {
            color: var(--primary);
        }

        .keyboard-shortcuts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--surface);
            border-radius: 4px;
        }

        .shortcut-key {
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin: 1rem 0;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .risk-cell {
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            color: white;
        }

        .risk-low { background: var(--success); }
        .risk-medium { background: var(--warning); color: black; }
        .risk-high { background: var(--danger); }
        .risk-critical { background: var(--critical); }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 95%;
                padding: 1rem;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loader {
            border: 4px solid var(--surface);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>Safety Analytics Platform</h1>
                <span style="color: #888; font-size: 0.875rem;">v2.1</span>
            </div>
            <div class="header-controls">
                <button class="help-btn" onclick="showHelpModal()">
                    <span>?</span>
                    <span>Help</span>
                </button>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Dark Mode</span>
                </button>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchModule('overview')">Overview</button>
            <button class="tab-btn" onclick="switchModule('injury')">Injury & Illness</button>
            <button class="tab-btn" onclick="switchModule('nearMiss')">Near Miss</button>
            <button class="tab-btn" onclick="switchModule('combined')">Combined Analytics</button>
            <button class="tab-btn" onclick="switchModule('reports')">Reports</button>
            <button class="tab-btn" onclick="switchModule('actions')">Action Tracking</button>
        </div>
    </nav>

    <div class="container">
        <!-- Overview Module -->
        <div id="overview" class="module-content active">
            <div class="upload-section">
                <h2>Quick Upload</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div class="upload-area" ondrop="handleDrop(event, 'injury')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <h3>üìä Injury & Illness Data</h3>
                        <p>Drop CSV file here or click to upload</p>
                        <input type="file" id="injuryFileOverview" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'injury')">
                        <label for="injuryFileOverview" class="upload-label">Choose File</label>
                        <div id="injuryFileInfo"></div>
                    </div>
                    <div class="upload-area" ondrop="handleDrop(event, 'nearMiss')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <h3>‚ö†Ô∏è Near Miss Data</h3>
                        <p>Drop CSV file here or click to upload</p>
                        <input type="file" id="nearMissFileOverview" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'nearMiss')">
                        <label for="nearMissFileOverview" class="upload-label">Choose File</label>
                        <div id="nearMissFileInfo"></div>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="overviewStats">
                <div class="stat-card">
                    <h3>Total Incidents</h3>
                    <div class="stat-value" id="totalIncidents">0</div>
                    <div class="stat-change positive">
                        <span>‚Üì 0%</span> vs last period
                    </div>
                </div>
                <div class="stat-card">
                    <h3>TRIR</h3>
                    <div class="stat-value" id="trirValue">0.00</div>
                    <div class="stat-change">Target: < 2.00</div>
                </div>
                <div class="stat-card">
                    <h3>Near Miss Frequency</h3>
                    <div class="stat-value" id="nmfrValue">0.00</div>
                    <div class="stat-change">Per 200,000 hours</div>
                </div>
                <div class="stat-card">
                    <h3>Critical Risks</h3>
                    <div class="stat-value" id="criticalRisks" style="color: var(--danger);">0</div>
                    <div class="stat-change">Requiring immediate action</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Safety Performance Trend</h3>
                    </div>
                    <canvas id="overviewTrendChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Risk Distribution Matrix</h3>
                    </div>
                    <canvas id="overviewRiskMatrix"></canvas>
                </div>
            </div>
        </div>

        <!-- Injury & Illness Module -->
        <div id="injury" class="module-content">
            <div class="upload-section">
                <h2>Upload Injury & Illness Data</h2>
                <div class="upload-area" ondrop="handleDrop(event, 'injury')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p>Drop your CSV file here or click to upload</p>
                    <input type="file" id="injuryFile" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'injury')">
                    <label for="injuryFile" class="upload-label">Choose File</label>
                </div>
            </div>

            <div class="filter-section" id="injuryFilters" style="display: none;">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Site</label>
                        <select id="injurySiteFilter" onchange="applyFilters('injury')">
                            <option value="">All Sites</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Severity</label>
                        <select id="injurySeverityFilter" onchange="applyFilters('injury')">
                            <option value="">All Severities</option>
                            <option value="A">A - Critical</option>
                            <option value="B">B - Serious</option>
                            <option value="C">C - Moderate</option>
                            <option value="D">D - Minor</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="injuryDateFrom" onchange="applyFilters('injury')">
                    </div>
                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="injuryDateTo" onchange="applyFilters('injury')">
                    </div>
                    <div class="filter-group">
                        <label>Recordable Only</label>
                        <select id="injuryRecordableFilter" onchange="applyFilters('injury')">
                            <option value="">All</option>
                            <option value="1">Recordable Only</option>
                            <option value="0">Non-Recordable</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-secondary" onclick="resetFilters('injury')">Reset</button>
                    <button class="btn btn-primary" onclick="exportToExcel('injury')">Export Excel</button>
                </div>
            </div>

            <div class="stats-grid" id="injuryStats" style="display: none;">
                <div class="stat-card">
                    <h3>Total Cases</h3>
                    <div class="stat-value" id="injuryTotal">0</div>
                </div>
                <div class="stat-card">
                    <h3>Recordable Cases</h3>
                    <div class="stat-value" id="injuryRecordable">0</div>
                </div>
                <div class="stat-card">
                    <h3>Days Away From Work</h3>
                    <div class="stat-value" id="injuryDAFW">0</div>
                </div>
                <div class="stat-card">
                    <h3>TRIR</h3>
                    <div class="stat-value" id="injuryTRIR">0.00</div>
                </div>
            </div>

            <div class="charts-grid" id="injuryCharts" style="display: none;">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Severity Distribution</h3>
                        <div class="chart-actions">
                            <button class="chart-btn" onclick="updateChart(1, 'injury', 'bar')">üìä</button>
                            <button class="chart-btn" onclick="updateChart(1, 'injury', 'pie')">ü•ß</button>
                            <button class="chart-btn" onclick="updateChart(1, 'injury', 'line')">üìà</button>
                        </div>
                    </div>
                    <canvas id="injuryChart1"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Monthly Trend</h3>
                        <div class="chart-actions">
                            <button class="chart-btn" onclick="updateChart(2, 'injury', 'bar')">üìä</button>
                            <button class="chart-btn" onclick="updateChart(2, 'injury', 'line')">üìà</button>
                        </div>
                    </div>
                    <canvas id="injuryChart2"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Body Parts Affected</h3>
                        <div class="chart-actions">
                            <button class="chart-btn" onclick="updateChart(3, 'injury', 'bar')">üìä</button>
                            <button class="chart-btn" onclick="updateChart(3, 'injury', 'doughnut')">üç©</button>
                        </div>
                    </div>
                    <canvas id="injuryChart3"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Root Causes</h3>
                        <div class="chart-actions">
                            <button class="chart-btn" onclick="updateChart(4, 'injury', 'bar')">üìä</button>
                            <button class="chart-btn" onclick="updateChart(4, 'injury', 'horizontalBar')">üìä</button>
                        </div>
                    </div>
                    <canvas id="injuryChart4"></canvas>
                </div>
            </div>

            <div class="table-container" id="injuryTableContainer" style="display: none;">
                <h3>Injury & Illness Details</h3>
                <table id="injuryTable">
                    <thead>
                        <tr>
                            <th>Case #</th>
                            <th>Date</th>
                            <th>Site</th>
                            <th>Severity</th>
                            <th>Body Part</th>
                            <th>Days Lost</th>
                            <th>Recordable</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="injuryTableBody"></tbody>
                </table>
                <div class="pagination" id="injuryPagination"></div>
            </div>
        </div>

        <!-- Near Miss Module -->
        <div id="nearMiss" class="module-content">
            <div class="upload-section">
                <h2>Upload Near Miss Data</h2>
                <div class="upload-area" ondrop="handleDrop(event, 'nearMiss')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p>Drop your CSV file here or click to upload</p>
                    <input type="file" id="nearMissFile" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'nearMiss')">
                    <label for="nearMissFile" class="upload-label">Choose File</label>
                </div>
            </div>

            <div class="filter-section" id="nearMissFilters" style="display: none;">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Site</label>
                        <select id="nearMissSiteFilter" onchange="applyFilters('nearMiss')">
                            <option value="">All Sites</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Potential Severity</label>
                        <select id="nearMissSeverityFilter" onchange="applyFilters('nearMiss')">
                            <option value="">All Severities</option>
                            <option value="A">A - Critical</option>
                            <option value="B">B - Serious</option>
                            <option value="C">C - Moderate</option>
                            <option value="D">D - Minor</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="nearMissDateFrom" onchange="applyFilters('nearMiss')">
                    </div>
                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="nearMissDateTo" onchange="applyFilters('nearMiss')">
                    </div>
                    <div class="filter-group">
                        <label>Risk Level</label>
                        <select id="nearMissRiskFilter" onchange="applyFilters('nearMiss')">
                            <option value="">All Risk Levels</option>
                            <option value="high">High (7-10)</option>
                            <option value="medium">Medium (4-6)</option>
                            <option value="low">Low (0-3)</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-secondary" onclick="resetFilters('nearMiss')">Reset</button>
                    <button class="btn btn-primary" onclick="exportToExcel('nearMiss')">Export Excel</button>
                </div>
            </div>

            <div class="stats-grid" id="nearMissStats" style="display: none;">
                <div class="stat-card">
                    <h3>Total Near Misses</h3>
                    <div class="stat-value" id="nearMissTotal">0</div>
                </div>
                <div class="stat-card">
                    <h3>High Risk Events</h3>
                    <div class="stat-value" id="nearMissHighRisk" style="color: var(--danger);">0</div>
                </div>
                <div class="stat-card">
                    <h3>Average Risk Score</h3>
                    <div class="stat-value" id="nearMissAvgRisk">0.0</div>
                </div>
                <div class="stat-card">
                    <h3>NMFR</h3>
                    <div class="stat-value" id="nearMissNMFR">0.00</div>
                </div>
            </div>

            <div class="charts-grid" id="nearMissCharts" style="display: none;">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Risk Distribution</h3>
                        <div class="chart-actions">
                            <button class="chart-btn" onclick="updateChart(1, 'nearMiss', 'bar')">üìä</button>
                            <button class="chart-btn" onclick="updateChart(1, 'nearMiss', 'pie')">ü•ß</button>
                        </div>
                    </div>
                    <canvas id="nearMissChart1"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Monthly Trend</h3>
                        <div class="chart-actions">
                            <button class="chart-btn" onclick="updateChart(2, 'nearMiss', 'line')">üìà</button>
                            <button class="chart-btn" onclick="updateChart(2, 'nearMiss', 'bar')">üìä</button>
                        </div>
                    </div>
                    <canvas id="nearMissChart2"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Location Analysis</h3>
                        <div class="chart-actions">
                            <button class="chart-btn" onclick="updateChart(3, 'nearMiss', 'bar')">üìä</button>
                            <button class="chart-btn" onclick="updateChart(3, 'nearMiss', 'horizontalBar')">üìä</button>
                        </div>
                    </div>
                    <canvas id="nearMissChart3"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Risk Matrix</h3>
                    </div>
                    <canvas id="nearMissChart4"></canvas>
                </div>
            </div>

            <div class="table-container" id="nearMissTableContainer" style="display: none;">
                <h3>Near Miss Details</h3>
                <table id="nearMissTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Site</th>
                            <th>Severity</th>
                            <th>Risk Score</th>
                            <th>Location</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="nearMissTableBody"></tbody>
                </table>
                <div class="pagination" id="nearMissPagination"></div>
            </div>
        </div>

        <!-- Combined Analytics Module -->
        <div id="combined" class="module-content">
            <div class="empty-state" id="combinedEmpty">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 17H7V10H9V17M13 17H11V7H13V17M17 17H15V13H17V17M19.5 19.1H4.5V5H3V19.1C3 20.2 3.9 21.1 5 21.1H19.5C20.6 21.1 21.5 20.2 21.5 19.1V5H20V19.1Z"/>
                </svg>
                <h2>Load Data First</h2>
                <p>Please upload both Injury & Illness and Near Miss data to view combined analytics</p>
            </div>

            <div id="combinedContent" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Safety Events</h3>
                        <div class="stat-value" id="combinedTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Safety Index</h3>
                        <div class="stat-value" id="safetyIndex">0.0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Risk Ratio</h3>
                        <div class="stat-value" id="riskRatio">0:0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Proactive Rate</h3>
                        <div class="stat-value" id="proactiveRate">0%</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Safety Performance Comparison</h3>
                        </div>
                        <canvas id="combinedChart1"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Combined Risk Analysis</h3>
                        </div>
                        <canvas id="combinedChart2"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Site Safety Score</h3>
                        </div>
                        <canvas id="combinedChart3"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Predictive Risk Trends</h3>
                        </div>
                        <canvas id="combinedChart4"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Module -->
        <div id="reports" class="module-content">
            <h2>Generate Reports</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('injury')">
                    <h3>üìä Injury & Illness Report</h3>
                    <p>Complete analysis of injury and illness data</p>
                    <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;">Generate PDF</button>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('nearMiss')">
                    <h3>‚ö†Ô∏è Near Miss Report</h3>
                    <p>Comprehensive near miss analysis</p>
                    <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;">Generate PDF</button>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('combined')">
                    <h3>üîÑ Combined Safety Report</h3>
                    <p>Full safety performance overview</p>
                    <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;">Generate PDF</button>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('executive')">
                    <h3>üìà Executive Summary</h3>
                    <p>High-level insights for leadership</p>
                    <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;">Generate PDF</button>
                </div>
            </div>
        </div>

        <!-- Action Tracking Module -->
        <div id="actions" class="module-content">
            <h2>Action Tracking</h2>
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                </svg>
                <h3>Coming Soon</h3>
                <p>Action tracking and corrective measures management will be available in the next update</p>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">üìö Safety Analytics Platform Help</h2>
                <button class="modal-close" onclick="closeHelpModal()">√ó</button>
            </div>
            
            <div class="help-content">
                <!-- Quick Start Section -->
                <div class="help-section">
                    <h3>üöÄ Quick Start Guide</h3>
                    <ol class="help-list">
                        <li>Upload your CSV files via the Overview tab or respective module tabs</li>
                        <li>Use filters to refine your data view</li>
                        <li>Explore visualizations and insights</li>
                        <li>Generate reports for stakeholder communication</li>
                    </ol>
                </div>

                <!-- Data Format Section -->
                <div class="help-section">
                    <h3>üìÅ CSV Data Format Requirements</h3>
                    
                    <h4>Injury & Illness CSV Columns:</h4>
                    <div class="help-card">
                        <ul class="help-list">
                            <li><strong>case_number</strong> - Unique case identifier</li>
                            <li><strong>incident_date</strong> - Date of incident (YYYY-MM-DD)</li>
                            <li><strong>site</strong> - Location/site name</li>
                            <li><strong>severity</strong> - Severity level (A, B, C, or D)</li>
                            <li><strong>recordable</strong> - Recordable status (0 or 1)</li>
                            <li><strong>total_dafw_days</strong> - Days away from work</li>
                            <li><strong>initial_info_principal_body_part</strong> - Affected body part</li>
                            <li><strong>rca_primary_cause</strong> - Root cause analysis</li>
                            <li><strong>status</strong> - Case status</li>
                        </ul>
                    </div>

                    <h4>Near Miss CSV Columns:</h4>
                    <div class="help-card">
                        <ul class="help-list">
                            <li><strong>incident_id</strong> - Unique incident identifier</li>
                            <li><strong>nearmiss_date</strong> - Date of near miss (YYYY-MM-DD)</li>
                            <li><strong>site</strong> - Location/site name</li>
                            <li><strong>potential_severity</strong> - Potential severity (A, B, C, or D)</li>
                            <li><strong>initial_risk_assessment_severity</strong> - Risk severity assessment</li>
                            <li><strong>initial_risk_assessment_likeliness</strong> - Likelihood assessment</li>
                            <li><strong>initial_info_location_event</strong> - Event location</li>
                            <li><strong>initial_info_nearmiss_type</strong> - Type of near miss</li>
                            <li><strong>status</strong> - Incident status</li>
                        </ul>
                    </div>
                </div>

                <!-- Features Section -->
                <div class="help-section">
                    <h3>‚ú® Key Features</h3>
                    <div class="help-grid">
                        <div class="help-card">
                            <h4>üìä Data Visualization</h4>
                            <p>Interactive charts with multiple view options (bar, line, pie, doughnut)</p>
                        </div>
                        <div class="help-card">
                            <h4>üîç Advanced Filtering</h4>
                            <p>Filter by site, severity, date range, and other parameters</p>
                        </div>
                        <div class="help-card">
                            <h4>üìà KPI Calculation</h4>
                            <p>Automatic calculation of TRIR, LTIR, DAFWR, and NMFR</p>
                        </div>
                        <div class="help-card">
                            <h4>üìë Report Generation</h4>
                            <p>Export data to PDF and Excel formats</p>
                        </div>
                        <div class="help-card">
                            <h4>üé® Dark Mode</h4>
                            <p>Toggle between light and dark themes for comfortable viewing</p>
                        </div>
                        <div class="help-card">
                            <h4>üîÑ Data Validation</h4>
                            <p>Automatic detection of incorrect CSV file types</p>
                        </div>
                    </div>
                </div>

                <!-- KPI Calculations Section -->
                <div class="help-section">
                    <h3>üìê KPI Calculations</h3>
                    <div class="help-card">
                        <p><strong>TRIR (Total Recordable Incident Rate)</strong><br>
                        Formula: (Recordable Cases / Hours Worked) √ó 200,000</p>
                    </div>
                    <div class="help-card">
                        <p><strong>LTIR (Lost Time Incident Rate)</strong><br>
                        Formula: (Lost Time Cases / Hours Worked) √ó 200,000</p>
                    </div>
                    <div class="help-card">
                        <p><strong>DAFWR (Days Away From Work Rate)</strong><br>
                        Formula: (Total Days Lost / Hours Worked) √ó 200,000</p>
                    </div>
                    <div class="help-card">
                        <p><strong>NMFR (Near Miss Frequency Rate)</strong><br>
                        Formula: (Near Miss Count / Hours Worked) √ó 200,000</p>
                    </div>
                </div>

                <!-- Risk Matrix Section -->
                <div class="help-section">
                    <h3>üéØ Risk Matrix Scoring</h3>
                    <p>Risk scores are calculated using severity and likelihood factors:</p>
                    <div style="margin: 1rem 0;">
                        <strong>Severity Scores:</strong> A=5, B=4, C=3, D=2, Unknown=1<br>
                        <strong>Likelihood Scores:</strong> Almost Certain=5, Likely=4, Possible=3, Unlikely=2, Rare=1<br>
                        <strong>Risk Score Formula:</strong> (Severity √ó Likelihood) / 5 √ó 2 (Scale: 0-10)
                    </div>
                    <div class="risk-matrix" style="max-width: 500px;">
                        <div class="risk-cell" style="background: #ddd; color: black;">Risk</div>
                        <div class="risk-cell risk-low">1</div>
                        <div class="risk-cell risk-low">2</div>
                        <div class="risk-cell risk-medium">3</div>
                        <div class="risk-cell risk-medium">4</div>
                        <div class="risk-cell risk-high">5</div>
                        <div class="risk-cell" style="background: #ddd; color: black;">Rare</div>
                        <div class="risk-cell risk-low">L</div>
                        <div class="risk-cell risk-low">L</div>
                        <div class="risk-cell risk-low">L</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell" style="background: #ddd; color: black;">Unlikely</div>
                        <div class="risk-cell risk-low">L</div>
                        <div class="risk-cell risk-low">L</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-high">H</div>
                        <div class="risk-cell" style="background: #ddd; color: black;">Possible</div>
                        <div class="risk-cell risk-low">L</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-high">H</div>
                        <div class="risk-cell risk-high">H</div>
                        <div class="risk-cell" style="background: #ddd; color: black;">Likely</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-high">H</div>
                        <div class="risk-cell risk-high">H</div>
                        <div class="risk-cell risk-critical">C</div>
                        <div class="risk-cell" style="background: #ddd; color: black;">Certain</div>
                        <div class="risk-cell risk-medium">M</div>
                        <div class="risk-cell risk-high">H</div>
                        <div class="risk-cell risk-high">H</div>
                        <div class="risk-cell risk-critical">C</div>
                        <div class="risk-cell risk-critical">C</div>
                    </div>
                </div>

                <!-- Keyboard Shortcuts Section -->
                <div class="help-section">
                    <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                    <div class="keyboard-shortcuts">
                        <div class="shortcut-item">
                            <span>Toggle Dark Mode</span>
                            <span class="shortcut-key">Ctrl + D</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Show Help</span>
                            <span class="shortcut-key">Ctrl + H</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Export Excel</span>
                            <span class="shortcut-key">Ctrl + E</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Generate Report</span>
                            <span class="shortcut-key">Ctrl + R</span>
                        </div>
                    </div>
                </div>

                <!-- Troubleshooting Section -->
                <div class="help-section">
                    <h3>üîß Troubleshooting</h3>
                    <div class="help-card">
                        <h4>CSV Upload Issues</h4>
                        <ul class="help-list">
                            <li>Ensure your CSV file contains the required columns</li>
                            <li>Check date formats (should be YYYY-MM-DD)</li>
                            <li>Verify that severity values are A, B, C, or D</li>
                            <li>The system will alert you if you upload the wrong CSV type</li>
                        </ul>
                    </div>
                    <div class="help-card">
                        <h4>Chart Display Problems</h4>
                        <ul class="help-list">
                            <li>Try refreshing the page</li>
                            <li>Ensure data is properly filtered</li>
                            <li>Check if there's sufficient data for visualization</li>
                        </ul>
                    </div>
                </div>

                <!-- Contact Section -->
                <div class="help-section">
                    <h3>üìû Support & Contact</h3>
                    <p><strong>Developer:</strong> Erwin Esener<br>
                    <strong>Organization:</strong> Amazon WHS Austria<br>
                    <strong>Version:</strong> 2.1<br>
                    <strong>Last Updated:</strong> 2024</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State Management
        const state = {
            injury: {
                rawData: [],
                filteredData: [],
                charts: {},
                currentPage: 1
            },
            nearMiss: {
                rawData: [],
                filteredData: [],
                charts: {},
                currentPage: 1
            },
            combined: {
                charts: {}
            },
            currentModule: 'overview',
            theme: localStorage.getItem('theme') || 'light',
            itemsPerPage: 15,
            hoursWorked: 200000 // Base hours for rate calculations
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (state.theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
            initializeOverviewCharts();
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey) {
                    switch(e.key.toLowerCase()) {
                        case 'd':
                            e.preventDefault();
                            toggleTheme();
                            break;
                        case 'h':
                            e.preventDefault();
                            showHelpModal();
                            break;
                        case 'e':
                            e.preventDefault();
                            if (state.currentModule === 'injury' || state.currentModule === 'nearMiss') {
                                exportToExcel(state.currentModule);
                            }
                            break;
                        case 'r':
                            e.preventDefault();
                            if (state.currentModule === 'reports') {
                                generateReport('combined');
                            }
                            break;
                    }
                }
            });
        });

        // CSV Type Validation
        function validateCSVType(headers, expectedType) {
            const injuryIndicators = ['case_number', 'incident_date', 'recordable', 'total_dafw_days', 'initial_info_principal_body_part', 'rca_primary_cause'];
            const nearMissIndicators = ['incident_id', 'nearmiss_date', 'potential_severity', 'initial_risk_assessment_severity', 'initial_risk_assessment_likeliness', 'initial_info_location_event'];
            
            const headerLower = headers.map(h => h.toLowerCase().trim());
            
            let injuryScore = 0;
            let nearMissScore = 0;
            
            injuryIndicators.forEach(indicator => {
                if (headerLower.includes(indicator.toLowerCase())) {
                    injuryScore++;
                }
            });
            
            nearMissIndicators.forEach(indicator => {
                if (headerLower.includes(indicator.toLowerCase())) {
                    nearMissScore++;
                }
            });
            
            const detectedType = injuryScore > nearMissScore ? 'injury' : 'nearMiss';
            
            if (detectedType !== expectedType) {
                return {
                    isValid: false,
                    detectedType: detectedType,
                    expectedType: expectedType,
                    injuryScore: injuryScore,
                    nearMissScore: nearMissScore
                };
            }
            
            return {
                isValid: true,
                detectedType: detectedType,
                expectedType: expectedType,
                injuryScore: injuryScore,
                nearMissScore: nearMissScore
            };
        }

        // File Upload Handler with Validation
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (results.data.length === 0) {
                        showStatus('No data found in file', 'error');
                        showLoading(false);
                        return;
                    }

                    // Validate CSV type
                    const validation = validateCSVType(results.meta.fields, type);
                    
                    if (!validation.isValid) {
                        showLoading(false);
                        
                        const confirmSwitch = confirm(
                            `‚ö†Ô∏è Wrong File Type Detected!\n\n` +
                            `You're trying to upload ${validation.detectedType === 'injury' ? 'Injury & Illness' : 'Near Miss'} data ` +
                            `to the ${validation.expectedType === 'injury' ? 'Injury & Illness' : 'Near Miss'} module.\n\n` +
                            `Detection Confidence:\n` +
                            `- Injury indicators found: ${validation.injuryScore}\n` +
                            `- Near Miss indicators found: ${validation.nearMissScore}\n\n` +
                            `Would you like to:\n` +
                            `[OK] - Switch and load this file in the correct module\n` +
                            `[Cancel] - Cancel the upload`
                        );
                        
                        if (confirmSwitch) {
                            // Switch to correct module and load data
                            const correctType = validation.detectedType;
                            switchModule(correctType);
                            
                            // Process data for the correct type
                            setTimeout(() => {
                                processData(results.data, correctType);
                                showStatus(`Data loaded successfully in ${correctType === 'injury' ? 'Injury & Illness' : 'Near Miss'} module`, 'success');
                            }, 500);
                        } else {
                            showStatus('Upload cancelled', 'warning');
                            event.target.value = ''; // Reset file input
                        }
                    } else {
                        // Correct file type, process normally
                        processData(results.data, type);
                        showStatus(`${type === 'injury' ? 'Injury & Illness' : 'Near Miss'} data loaded successfully`, 'success');
                    }
                },
                error: (error) => {
                    showStatus(`Error parsing CSV: ${error.message}`, 'error');
                    showLoading(false);
                }
            });
        }

        function processData(data, type) {
            if (type === 'injury') {
                state.injury.rawData = processInjuryData(data);
                state.injury.filteredData = [...state.injury.rawData];
                updateInjuryDashboard();
            } else {
                state.nearMiss.rawData = processNearMissData(data);
                state.nearMiss.filteredData = [...state.nearMiss.rawData];
                updateNearMissDashboard();
            }
            
            // Update combined analytics if both datasets are loaded
            if (state.injury.rawData.length > 0 && state.nearMiss.rawData.length > 0) {
                updateCombinedAnalytics();
            }
            
            showLoading(false);
        }

        // Data Processing Functions
        function processInjuryData(rawData) {
            return rawData.map(row => ({
                caseNumber: row.case_number || `CASE-${Math.random().toString(36).substr(2, 9)}`,
                date: parseDate(row.incident_date),
                site: row.site || 'Unknown',
                severity: standardizeSeverity(row.severity),
                bodyPart: row.initial_info_principal_body_part || 'Not specified',
                daysLost: parseInt(row.total_dafw_days) || 0,
                recordable: parseInt(row.recordable) || 0,
                status: row.status || 'Open',
                rootCause: row.rca_primary_cause || 'Under investigation',
                ...row
            }));
        }

        function processNearMissData(rawData) {
            return rawData.map(row => ({
                id: row.incident_id || `NM-${Math.random().toString(36).substr(2, 9)}`,
                date: parseDate(row.nearmiss_date),
                site: row.site || 'Unknown',
                severity: standardizeSeverity(row.potential_severity),
                severityScore: getSeverityScore(row.initial_risk_assessment_severity || row.potential_severity),
                likelihood: standardizeLikelihood(row.initial_risk_assessment_likeliness),
                likelihoodScore: getLikelihoodScore(row.initial_risk_assessment_likeliness),
                riskScore: calculateRiskScore(
                    row.initial_risk_assessment_severity || row.potential_severity,
                    row.initial_risk_assessment_likeliness
                ),
                location: row.initial_info_location_event || 'Not specified',
                type: row.initial_info_nearmiss_type || 'Other',
                status: row.status || 'Open',
                ...row
            }));
        }

        // Utility Functions
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            const date = new Date(dateStr);
            return isNaN(date) ? new Date() : date;
        }

        function standardizeSeverity(severity) {
            if (!severity) return 'D';
            const s = severity.toString().toUpperCase();
            if (s.includes('A') || s.includes('CRITICAL')) return 'A';
            if (s.includes('B') || s.includes('SERIOUS')) return 'B';
            if (s.includes('C') || s.includes('MODERATE')) return 'C';
            return 'D';
        }

        function standardizeLikelihood(likelihood) {
            if (!likelihood) return 'Rare';
            const l = likelihood.toString().toLowerCase();
            if (l.includes('certain') || l.includes('almost')) return 'Almost Certain';
            if (l.includes('likely')) return 'Likely';
            if (l.includes('possible')) return 'Possible';
            if (l.includes('unlikely')) return 'Unlikely';
            return 'Rare';
        }

        function getSeverityScore(severity) {
            const s = standardizeSeverity(severity);
            return { 'A': 5, 'B': 4, 'C': 3, 'D': 2 }[s] || 1;
        }

        function getLikelihoodScore(likelihood) {
            const l = standardizeLikelihood(likelihood);
            return {
                'Almost Certain': 5,
                'Likely': 4,
                'Possible': 3,
                'Unlikely': 2,
                'Rare': 1
            }[l] || 1;
        }

        function calculateRiskScore(severity, likelihood) {
            const sevScore = getSeverityScore(severity);
            const likeScore = getLikelihoodScore(likelihood);
            return ((sevScore * likeScore) / 5) * 2; // Scale to 0-10
        }

        // Module Switching
        function switchModule(module) {
            // Update active states
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.module-content').forEach(content => content.classList.remove('active'));
            
            // Set active module
            event.target?.classList.add('active') || 
                document.querySelector(`.tab-btn:nth-child(${['overview', 'injury', 'nearMiss', 'combined', 'reports', 'actions'].indexOf(module) + 1})`).classList.add('active');
            document.getElementById(module).classList.add('active');
            
            state.currentModule = module;
        }

        // Theme Toggle
        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            
            if (isDark) {
                document.body.removeAttribute('data-theme');
                document.getElementById('themeIcon').textContent = 'üåô';
                document.getElementById('themeText').textContent = 'Dark Mode';
                state.theme = 'light';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeText').textContent = 'Light Mode';
                state.theme = 'dark';
            }
            
            localStorage.setItem('theme', state.theme);
            
            // Update all charts for theme change
            Object.values(state.injury.charts).forEach(chart => {
                if (chart) updateChartTheme(chart);
            });
            Object.values(state.nearMiss.charts).forEach(chart => {
                if (chart) updateChartTheme(chart);
            });
        }

        function updateChartTheme(chart) {
            const isDark = state.theme === 'dark';
            const textColor = isDark ? '#e0e0e0' : '#333';
            const gridColor = isDark ? '#444' : '#ddd';
            
            chart.options.plugins.legend.labels.color = textColor;
            chart.options.scales.x && (chart.options.scales.x.ticks.color = textColor);
            chart.options.scales.y && (chart.options.scales.y.ticks.color = textColor);
            chart.options.scales.x && (chart.options.scales.x.grid.color = gridColor);
            chart.options.scales.y && (chart.options.scales.y.grid.color = gridColor);
            
            chart.update();
        }

        // Help Modal Functions
        function showHelpModal() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                closeHelpModal();
            }
        }

        // Dashboard Update Functions
        function updateInjuryDashboard() {
            const data = state.injury.filteredData;
            
            // Show sections
            document.getElementById('injuryFilters').style.display = 'block';
            document.getElementById('injuryStats').style.display = 'grid';
            document.getElementById('injuryCharts').style.display = 'grid';
            document.getElementById('injuryTableContainer').style.display = 'block';
            
            // Update filters
            updateFilters('injury');
            
            // Update stats
            const recordableCount = data.filter(d => d.recordable === 1).length;
            const totalDaysLost = data.reduce((sum, d) => sum + d.daysLost, 0);
            const trir = (recordableCount / state.hoursWorked) * 200000;
            
            document.getElementById('injuryTotal').textContent = data.length;
            document.getElementById('injuryRecordable').textContent = recordableCount;
            document.getElementById('injuryDAFW').textContent = totalDaysLost;
            document.getElementById('injuryTRIR').textContent = trir.toFixed(2);
            
            // Update charts
            updateInjuryCharts();
            
            // Update table
            updateInjuryTable();
            
            // Update overview if on overview tab
            if (state.currentModule === 'overview') {
                updateOverview();
            }
        }

        function updateNearMissDashboard() {
            const data = state.nearMiss.filteredData;
            
            // Show sections
            document.getElementById('nearMissFilters').style.display = 'block';
            document.getElementById('nearMissStats').style.display = 'grid';
            document.getElementById('nearMissCharts').style.display = 'grid';
            document.getElementById('nearMissTableContainer').style.display = 'block';
            
            // Update filters
            updateFilters('nearMiss');
            
            // Update stats
            const highRiskCount = data.filter(d => d.riskScore >= 7).length;
            const avgRisk = data.reduce((sum, d) => sum + d.riskScore, 0) / data.length || 0;
            const nmfr = (data.length / state.hoursWorked) * 200000;
            
            document.getElementById('nearMissTotal').textContent = data.length;
            document.getElementById('nearMissHighRisk').textContent = highRiskCount;
            document.getElementById('nearMissAvgRisk').textContent = avgRisk.toFixed(1);
            document.getElementById('nearMissNMFR').textContent = nmfr.toFixed(2);
            
            // Update charts
            updateNearMissCharts();
            
            // Update table
            updateNearMissTable();
            
            // Update overview if on overview tab
            if (state.currentModule === 'overview') {
                updateOverview();
            }
        }

        function updateFilters(type) {
            const data = state[type].rawData;
            const siteFilter = document.getElementById(`${type}SiteFilter`);
            
            // Get unique sites
            const sites = [...new Set(data.map(d => d.site))].sort();
            
            // Update site filter
            siteFilter.innerHTML = '<option value="">All Sites</option>';
            sites.forEach(site => {
                siteFilter.innerHTML += `<option value="${site}">${site}</option>`;
            });
        }

        function applyFilters(type) {
            const siteFilter = document.getElementById(`${type}SiteFilter`).value;
            const severityFilter = document.getElementById(`${type}SeverityFilter`).value;
            const dateFrom = document.getElementById(`${type}DateFrom`).value;
            const dateTo = document.getElementById(`${type}DateTo`).value;
            
            let filtered = [...state[type].rawData];
            
            if (siteFilter) {
                filtered = filtered.filter(d => d.site === siteFilter);
            }
            
            if (severityFilter) {
                filtered = filtered.filter(d => d.severity === severityFilter);
            }
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(d => d.date >= fromDate);
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                filtered = filtered.filter(d => d.date <= toDate);
            }
            
            if (type === 'injury') {
                const recordableFilter = document.getElementById('injuryRecordableFilter').value;
                if (recordableFilter) {
                    filtered = filtered.filter(d => d.recordable === parseInt(recordableFilter));
                }
            }
            
            if (type === 'nearMiss') {
                const riskFilter = document.getElementById('nearMissRiskFilter').value;
                if (riskFilter) {
                    if (riskFilter === 'high') {
                        filtered = filtered.filter(d => d.riskScore >= 7);
                    } else if (riskFilter === 'medium') {
                        filtered = filtered.filter(d => d.riskScore >= 4 && d.riskScore < 7);
                    } else if (riskFilter === 'low') {
                        filtered = filtered.filter(d => d.riskScore < 4);
                    }
                }
            }
            
            state[type].filteredData = filtered;
            state[type].currentPage = 1;
            
            if (type === 'injury') {
                updateInjuryDashboard();
            } else {
                updateNearMissDashboard();
            }
        }

        function resetFilters(type) {
            document.getElementById(`${type}SiteFilter`).value = '';
            document.getElementById(`${type}SeverityFilter`).value = '';
            document.getElementById(`${type}DateFrom`).value = '';
            document.getElementById(`${type}DateTo`).value = '';
            
            if (type === 'injury') {
                document.getElementById('injuryRecordableFilter').value = '';
            } else {
                document.getElementById('nearMissRiskFilter').value = '';
            }
            
            state[type].filteredData = [...state[type].rawData];
            state[type].currentPage = 1;
            
            if (type === 'injury') {
                updateInjuryDashboard();
            } else {
                updateNearMissDashboard();
            }
        }

        // Chart Update Functions
        function updateInjuryCharts() {
            const data = state.injury.filteredData;
            
            // Chart 1: Severity Distribution
            const severityCounts = { 'A': 0, 'B': 0, 'C': 0, 'D': 0 };
            data.forEach(d => severityCounts[d.severity]++);
            
            updateOrCreateChart('injuryChart1', {
                type: 'doughnut',
                data: {
                    labels: Object.keys(severityCounts),
                    datasets: [{
                        data: Object.values(severityCounts),
                        backgroundColor: ['#B71C1C', '#FF5722', '#FFC107', '#4CAF50']
                    }]
                }
            }, 'injury', 1);
            
            // Chart 2: Monthly Trend
            const monthlyData = {};
            data.forEach(d => {
                const month = `${d.date.getFullYear()}-${String(d.date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            updateOrCreateChart('injuryChart2', {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Incidents',
                        data: sortedMonths.map(m => monthlyData[m]),
                        borderColor: '#FF9900',
                        tension: 0.3,
                        fill: false
                    }]
                }
            }, 'injury', 2);
            
            // Chart 3: Body Parts
            const bodyPartCounts = {};
            data.forEach(d => {
                bodyPartCounts[d.bodyPart] = (bodyPartCounts[d.bodyPart] || 0) + 1;
            });
            
            const topBodyParts = Object.entries(bodyPartCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            updateOrCreateChart('injuryChart3', {
                type: 'bar',
                data: {
                    labels: topBodyParts.map(bp => bp[0]),
                    datasets: [{
                        label: 'Count',
                        data: topBodyParts.map(bp => bp[1]),
                        backgroundColor: '#FF9900'
                    }]
                }
            }, 'injury', 3);
            
            // Chart 4: Root Causes
            const rootCauseCounts = {};
            data.forEach(d => {
                const cause = d.rootCause || 'Unknown';
                rootCauseCounts[cause] = (rootCauseCounts[cause] || 0) + 1;
            });
            
            const topCauses = Object.entries(rootCauseCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            updateOrCreateChart('injuryChart4', {
                type: 'horizontalBar',
                data: {
                    labels: topCauses.map(c => c[0]),
                    datasets: [{
                        label: 'Count',
                        data: topCauses.map(c => c[1]),
                        backgroundColor: '#232F3E'
                    }]
                }
            }, 'injury', 4);
        }

        function updateNearMissCharts() {
            const data = state.nearMiss.filteredData;
            
            // Chart 1: Risk Distribution
            const riskCategories = { 'Low (0-3)': 0, 'Medium (4-6)': 0, 'High (7-10)': 0 };
            data.forEach(d => {
                if (d.riskScore < 4) riskCategories['Low (0-3)']++;
                else if (d.riskScore < 7) riskCategories['Medium (4-6)']++;
                else riskCategories['High (7-10)']++;
            });
            
            updateOrCreateChart('nearMissChart1', {
                type: 'pie',
                data: {
                    labels: Object.keys(riskCategories),
                    datasets: [{
                        data: Object.values(riskCategories),
                        backgroundColor: ['#4CAF50', '#FFC107', '#FF5722']
                    }]
                }
            }, 'nearMiss', 1);
            
            // Chart 2: Monthly Trend
            const monthlyData = {};
            data.forEach(d => {
                const month = `${d.date.getFullYear()}-${String(d.date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            updateOrCreateChart('nearMissChart2', {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Near Misses',
                        data: sortedMonths.map(m => monthlyData[m]),
                        borderColor: '#2196F3',
                        tension: 0.3,
                        fill: false
                    }]
                }
            }, 'nearMiss', 2);
            
            // Chart 3: Location Analysis
            const locationCounts = {};
            data.forEach(d => {
                const location = d.location || 'Unknown';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });
            
            const topLocations = Object.entries(locationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            updateOrCreateChart('nearMissChart3', {
                type: 'bar',
                data: {
                    labels: topLocations.map(l => l[0]),
                    datasets: [{
                        label: 'Count',
                        data: topLocations.map(l => l[1]),
                        backgroundColor: '#FF9900'
                    }]
                }
            }, 'nearMiss', 3);
            
            // Chart 4: Risk Matrix
            const matrixData = [];
            for (let sev = 5; sev >= 1; sev--) {
                for (let like = 1; like <= 5; like++) {
                    const count = data.filter(d => 
                        d.severityScore === sev && d.likelihoodScore === like
                    ).length;
                    matrixData.push({
                        x: like,
                        y: sev,
                        v: count
                    });
                }
            }
            
            updateOrCreateChart('nearMissChart4', {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Risk Matrix',
                        data: matrixData.map(d => ({
                            x: d.x,
                            y: d.y,
                            r: Math.sqrt(d.v) * 5
                        })),
                        backgroundColor: matrixData.map(d => {
                            const risk = (d.x * d.y) / 5 * 2;
                            if (risk >= 7) return 'rgba(183, 28, 28, 0.6)';
                            if (risk >= 4) return 'rgba(255, 193, 7, 0.6)';
                            return 'rgba(76, 175, 80, 0.6)';
                        })
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: { display: true, text: 'Likelihood' },
                            min: 0, max: 6,
                            ticks: {
                                callback: (v) => ['', 'Rare', 'Unlikely', 'Possible', 'Likely', 'Certain', ''][v]
                            }
                        },
                        y: {
                            title: { display: true, text: 'Severity' },
                            min: 0, max: 6,
                            ticks: {
                                callback: (v) => ['', 'D', 'C', 'B', 'A', '', ''][v]
                            }
                        }
                    }
                }
            }, 'nearMiss', 4);
        }

        function updateOrCreateChart(canvasId, config, module, chartNum) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const chartKey = `chart${chartNum}`;
            
            if (state[module].charts[chartKey]) {
                state[module].charts[chartKey].destroy();
            }
            
            const isDark = state.theme === 'dark';
            const textColor = isDark ? '#e0e0e0' : '#333';
            const gridColor = isDark ? '#444' : '#ddd';
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: textColor }
                    }
                },
                scales: {}
            };
            
            if (config.type === 'bar' || config.type === 'line' || config.type === 'horizontalBar') {
                defaultOptions.scales = {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                };
            }
            
            config.options = { ...defaultOptions, ...config.options };
            
            state[module].charts[chartKey] = new Chart(ctx, config);
        }

        function updateChart(chartNum, module, chartType) {
            const chart = state[module].charts[`chart${chartNum}`];
            if (!chart) return;
            
            chart.config.type = chartType;
            chart.update();
        }

        // Table Functions
        function updateInjuryTable() {
            const data = state.injury.filteredData;
            const tbody = document.getElementById('injuryTableBody');
            const startIdx = (state.injury.currentPage - 1) * state.itemsPerPage;
            const endIdx = startIdx + state.itemsPerPage;
            const pageData = data.slice(startIdx, endIdx);
            
            tbody.innerHTML = pageData.map(d => `
                <tr>
                    <td>${d.caseNumber}</td>
                    <td>${d.date.toLocaleDateString()}</td>
                    <td>${d.site}</td>
                    <td><span class="severity-badge severity-${d.severity}">${d.severity}</span></td>
                    <td>${d.bodyPart}</td>
                    <td>${d.daysLost}</td>
                    <td>${d.recordable ? 'Yes' : 'No'}</td>
                    <td>${d.status}</td>
                </tr>
            `).join('');
            
            updatePagination('injury', data.length);
        }

        function updateNearMissTable() {
            const data = state.nearMiss.filteredData;
            const tbody = document.getElementById('nearMissTableBody');
            const startIdx = (state.nearMiss.currentPage - 1) * state.itemsPerPage;
            const endIdx = startIdx + state.itemsPerPage;
            const pageData = data.slice(startIdx, endIdx);
            
            tbody.innerHTML = pageData.map(d => {
                let riskClass = 'severity-D';
                if (d.riskScore >= 7) riskClass = 'severity-A';
                else if (d.riskScore >= 4) riskClass = 'severity-C';
                
                return `
                <tr>
                    <td>${d.id}</td>
                    <td>${d.date.toLocaleDateString()}</td>
                    <td>${d.site}</td>
                    <td><span class="severity-badge severity-${d.severity}">${d.severity}</span></td>
                    <td><span class="severity-badge ${riskClass}">${d.riskScore.toFixed(1)}</span></td>
                    <td>${d.location}</td>
                    <td>${d.type}</td>
                    <td>${d.status}</td>
                </tr>
            `}).join('');
            
            updatePagination('nearMiss', data.length);
        }

        function updatePagination(type, totalItems) {
            const totalPages = Math.ceil(totalItems / state.itemsPerPage);
            const currentPage = state[type].currentPage;
            const paginationDiv = document.getElementById(`${type}Pagination`);
            
            paginationDiv.innerHTML = `
                <button onclick="changePage('${type}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                <span>Page ${currentPage} of ${totalPages}</span>
                <button onclick="changePage('${type}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
            `;
        }

        function changePage(type, newPage) {
            state[type].currentPage = newPage;
            if (type === 'injury') {
                updateInjuryTable();
            } else {
                updateNearMissTable();
            }
        }

        // Overview Functions
        function initializeOverviewCharts() {
            const ctx1 = document.getElementById('overviewTrendChart');
            const ctx2 = document.getElementById('overviewRiskMatrix');
            
            if (!ctx1 || !ctx2) return;
            
            const isDark = state.theme === 'dark';
            const textColor = isDark ? '#e0e0e0' : '#333';
            const gridColor = isDark ? '#444' : '#ddd';
            
            // Trend Chart
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Injuries',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#FF9900',
                        backgroundColor: 'rgba(255, 153, 0, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Near Misses',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: textColor }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        y: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
            
            // Risk Matrix
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical Risk'],
                    datasets: [{
                        label: 'Events',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#4CAF50', '#FFC107', '#FF5722', '#B71C1C']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: textColor }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        y: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        function updateOverview() {
            const injuryCount = state.injury.filteredData.length;
            const nearMissCount = state.nearMiss.filteredData.length;
            const recordableCount = state.injury.filteredData.filter(d => d.recordable === 1).length;
            const criticalCount = state.injury.filteredData.filter(d => d.severity === 'A').length +
                                 state.nearMiss.filteredData.filter(d => d.riskScore >= 7).length;
            
            const trir = (recordableCount / state.hoursWorked) * 200000;
            const nmfr = (nearMissCount / state.hoursWorked) * 200000;
            
            // Update stats
            document.getElementById('totalIncidents').textContent = injuryCount + nearMissCount;
            document.getElementById('trirValue').textContent = trir.toFixed(2);
            document.getElementById('nmfrValue').textContent = nmfr.toFixed(2);
            document.getElementById('criticalRisks').textContent = criticalCount;
            
            // Update overview charts if data exists
            if (injuryCount > 0 || nearMissCount > 0) {
                updateOverviewCharts();
            }
        }

        function updateOverviewCharts() {
            // Update trend chart
            const trendChart = Chart.getChart('overviewTrendChart');
            if (trendChart) {
                const injuryMonthly = {};
                const nearMissMonthly = {};
                
                state.injury.filteredData.forEach(d => {
                    const month = d.date.toLocaleString('default', { month: 'short' });
                    injuryMonthly[month] = (injuryMonthly[month] || 0) + 1;
                });
                
                state.nearMiss.filteredData.forEach(d => {
                    const month = d.date.toLocaleString('default', { month: 'short' });
                    nearMissMonthly[month] = (nearMissMonthly[month] || 0) + 1;
                });
                
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                trendChart.data.labels = months;
                trendChart.data.datasets[0].data = months.map(m => injuryMonthly[m] || 0);
                trendChart.data.datasets[1].data = months.map(m => nearMissMonthly[m] || 0);
                trendChart.update();
            }
            
            // Update risk matrix chart
            const matrixChart = Chart.getChart('overviewRiskMatrix');
            if (matrixChart) {
                const riskCounts = [0, 0, 0, 0];
                
                state.injury.filteredData.forEach(d => {
                    if (d.severity === 'D') riskCounts[0]++;
                    else if (d.severity === 'C') riskCounts[1]++;
                    else if (d.severity === 'B') riskCounts[2]++;
                    else if (d.severity === 'A') riskCounts[3]++;
                });
                
                state.nearMiss.filteredData.forEach(d => {
                    if (d.riskScore < 3) riskCounts[0]++;
                    else if (d.riskScore < 5) riskCounts[1]++;
                    else if (d.riskScore < 7) riskCounts[2]++;
                    else riskCounts[3]++;
                });
                
                matrixChart.data.datasets[0].data = riskCounts;
                matrixChart.update();
            }
        }

        // Combined Analytics
        function updateCombinedAnalytics() {
            document.getElementById('combinedEmpty').style.display = 'none';
            document.getElementById('combinedContent').style.display = 'block';
            
            const injuryData = state.injury.filteredData;
            const nearMissData = state.nearMiss.filteredData;
            
            // Calculate combined metrics
            const totalEvents = injuryData.length + nearMissData.length;
            const safetyIndex = calculateSafetyIndex();
            const riskRatio = `${nearMissData.length}:${injuryData.length}`;
            const proactiveRate = nearMissData.length > 0 ? 
                ((nearMissData.length / totalEvents) * 100).toFixed(1) : 0;
            
            // Update stats
            document.getElementById('combinedTotal').textContent = totalEvents;
            document.getElementById('safetyIndex').textContent = safetyIndex.toFixed(1);
            document.getElementById('riskRatio').textContent = riskRatio;
            document.getElementById('proactiveRate').textContent = `${proactiveRate}%`;
            
            // Update combined charts
            updateCombinedCharts();
        }

        function calculateSafetyIndex() {
            const injuryScore = state.injury.filteredData.reduce((sum, d) => {
                return sum + (5 - getSeverityScore(d.severity));
            }, 0);
            
            const nearMissScore = state.nearMiss.filteredData.reduce((sum, d) => {
                return sum + (10 - d.riskScore);
            }, 0);
            
            const totalPossible = (state.injury.filteredData.length * 4) + 
                                 (state.nearMiss.filteredData.length * 10);
            
            if (totalPossible === 0) return 10;
            
            return ((injuryScore + nearMissScore) / totalPossible) * 10;
        }

        function updateCombinedCharts() {
            // Chart 1: Safety Performance Comparison
            const ctx1 = document.getElementById('combinedChart1');
            if (ctx1) {
                updateOrCreateChart('combinedChart1', {
                    type: 'bar',
                    data: {
                        labels: ['Injuries', 'Near Misses', 'Recordable', 'Critical'],
                        datasets: [{
                            label: 'Count',
                            data: [
                                state.injury.filteredData.length,
                                state.nearMiss.filteredData.length,
                                state.injury.filteredData.filter(d => d.recordable === 1).length,
                                state.injury.filteredData.filter(d => d.severity === 'A').length +
                                state.nearMiss.filteredData.filter(d => d.riskScore >= 7).length
                            ],
                            backgroundColor: ['#FF9900', '#2196F3', '#FFC107', '#FF5722']
                        }]
                    }
                }, 'combined', 1);
            }
            
            // Chart 2: Combined Risk Analysis
            const ctx2 = document.getElementById('combinedChart2');
            if (ctx2) {
                const riskData = {
                    'Low': 0,
                    'Medium': 0,
                    'High': 0,
                    'Critical': 0
                };
                
                state.injury.filteredData.forEach(d => {
                    if (d.severity === 'D') riskData.Low++;
                    else if (d.severity === 'C') riskData.Medium++;
                    else if (d.severity === 'B') riskData.High++;
                    else riskData.Critical++;
                });
                
                state.nearMiss.filteredData.forEach(d => {
                    if (d.riskScore < 3) riskData.Low++;
                    else if (d.riskScore < 5) riskData.Medium++;
                    else if (d.riskScore < 7) riskData.High++;
                    else riskData.Critical++;
                });
                
                updateOrCreateChart('combinedChart2', {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(riskData),
                        datasets: [{
                            data: Object.values(riskData),
                            backgroundColor: ['#4CAF50', '#FFC107', '#FF5722', '#B71C1C']
                        }]
                    }
                }, 'combined', 2);
            }
            
            // Chart 3: Site Safety Score
            const ctx3 = document.getElementById('combinedChart3');
            if (ctx3) {
                const siteScores = {};
                const allSites = new Set([
                    ...state.injury.filteredData.map(d => d.site),
                    ...state.nearMiss.filteredData.map(d => d.site)
                ]);
                
                allSites.forEach(site => {
                    const injuryCount = state.injury.filteredData.filter(d => d.site === site).length;
                    const nearMissCount = state.nearMiss.filteredData.filter(d => d.site === site).length;
                    const totalCount = injuryCount + nearMissCount;
                    
                    if (totalCount > 0) {
                        const ratio = nearMissCount / (injuryCount || 1);
                        siteScores[site] = Math.min(ratio * 2, 10);
                    }
                });
                
                const sortedSites = Object.entries(siteScores)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                updateOrCreateChart('combinedChart3', {
                    type: 'horizontalBar',
                    data: {
                        labels: sortedSites.map(s => s[0]),
                        datasets: [{
                            label: 'Safety Score',
                            data: sortedSites.map(s => s[1]),
                            backgroundColor: sortedSites.map(s => 
                                s[1] >= 7 ? '#4CAF50' : s[1] >= 4 ? '#FFC107' : '#FF5722'
                            )
                        }]
                    }
                }, 'combined', 3);
            }
            
            // Chart 4: Predictive Risk Trends
            const ctx4 = document.getElementById('combinedChart4');
            if (ctx4) {
                const monthlyRisk = {};
                
                [...state.injury.filteredData, ...state.nearMiss.filteredData].forEach(d => {
                    const month = `${d.date.getFullYear()}-${String(d.date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyRisk[month]) {
                        monthlyRisk[month] = { total: 0, risk: 0 };
                    }
                    monthlyRisk[month].total++;
                    
                    if (d.severity) {
                        monthlyRisk[month].risk += getSeverityScore(d.severity);
                    } else if (d.riskScore) {
                        monthlyRisk[month].risk += d.riskScore;
                    }
                });
                
                const sortedMonths = Object.keys(monthlyRisk).sort();
                const riskTrend = sortedMonths.map(m => 
                    monthlyRisk[m].total > 0 ? monthlyRisk[m].risk / monthlyRisk[m].total : 0
                );
                
                updateOrCreateChart('combinedChart4', {
                    type: 'line',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: 'Average Risk Score',
                            data: riskTrend,
                            borderColor: '#FF5722',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            tension: 0.3
                        }]
                    }
                }, 'combined', 4);
            }
        }

        // Report Generation
        function generateReport(type) {
            showLoading(true);
            
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFillColor(35, 47, 62);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 153, 0);
                doc.setFontSize(24);
                doc.text('Safety Analytics Report', 105, 20, { align: 'center' });
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text(`Report Type: ${type.toUpperCase()}`, 105, 30, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 36, { align: 'center' });
                
                // Reset text color
                doc.setTextColor(0, 0, 0);
                
                let yPos = 50;
                
                if (type === 'injury' || type === 'combined' || type === 'executive') {
                    if (state.injury.filteredData.length > 0) {
                        doc.setFontSize(16);
                        doc.text('Injury & Illness Summary', 20, yPos);
                        yPos += 10;
                        
                        doc.setFontSize(10);
                        doc.text(`Total Cases: ${state.injury.filteredData.length}`, 20, yPos);
                        yPos += 6;
                        doc.text(`Recordable Cases: ${state.injury.filteredData.filter(d => d.recordable === 1).length}`, 20, yPos);
                        yPos += 6;
                        doc.text(`Days Away From Work: ${state.injury.filteredData.reduce((sum, d) => sum + d.daysLost, 0)}`, 20, yPos);
                        yPos += 6;
                        
                        const trir = (state.injury.filteredData.filter(d => d.recordable === 1).length / state.hoursWorked) * 200000;
                        doc.text(`TRIR: ${trir.toFixed(2)}`, 20, yPos);
                        yPos += 15;
                    }
                }
                
                if (type === 'nearMiss' || type === 'combined' || type === 'executive') {
                    if (state.nearMiss.filteredData.length > 0) {
                        doc.setFontSize(16);
                        doc.text('Near Miss Summary', 20, yPos);
                        yPos += 10;
                        
                        doc.setFontSize(10);
                        doc.text(`Total Near Misses: ${state.nearMiss.filteredData.length}`, 20, yPos);
                        yPos += 6;
                        doc.text(`High Risk Events: ${state.nearMiss.filteredData.filter(d => d.riskScore >= 7).length}`, 20, yPos);
                        yPos += 6;
                        
                        const avgRisk = state.nearMiss.filteredData.reduce((sum, d) => sum + d.riskScore, 0) / 
                                       state.nearMiss.filteredData.length || 0;
                        doc.text(`Average Risk Score: ${avgRisk.toFixed(1)}`, 20, yPos);
                        yPos += 6;
                        
                        const nmfr = (state.nearMiss.filteredData.length / state.hoursWorked) * 200000;
                        doc.text(`NMFR: ${nmfr.toFixed(2)}`, 20, yPos);
                        yPos += 15;
                    }
                }
                
                if (type === 'executive') {
                    doc.setFontSize(16);
                    doc.text('Executive Summary', 20, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    const safetyIndex = calculateSafetyIndex();
                    doc.text(`Safety Index: ${safetyIndex.toFixed(1)}/10`, 20, yPos);
                    yPos += 6;
                    
                    const totalEvents = state.injury.filteredData.length + state.nearMiss.filteredData.length;
                    const proactiveRate = state.nearMiss.filteredData.length > 0 ? 
                        ((state.nearMiss.filteredData.length / totalEvents) * 100).toFixed(1) : 0;
                    doc.text(`Proactive Reporting Rate: ${proactiveRate}%`, 20, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(12);
                    doc.text('Key Recommendations:', 20, yPos);
                    yPos += 8;
                    doc.setFontSize(10);
                    doc.text('‚Ä¢ Focus on high-risk areas identified in the analysis', 25, yPos);
                    yPos += 6;
                    doc.text('‚Ä¢ Increase near miss reporting to improve proactive safety', 25, yPos);
                    yPos += 6;
                    doc.text('‚Ä¢ Implement targeted training for frequently affected body parts', 25, yPos);
                }
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Safety Analytics Platform v2.1 - Amazon WHS Austria', 105, 290, { align: 'center' });
                
                // Save PDF
                doc.save(`safety_report_${type}_${Date.now()}.pdf`);
                showStatus('Report generated successfully', 'success');
                showLoading(false);
            }, 1000);
        }

        // Excel Export
        function exportToExcel(type) {
            const data = state[type].filteredData;
            if (data.length === 0) {
                showStatus('No data to export', 'warning');
                return;
            }
            
            showLoading(true);
            
            setTimeout(() => {
                const ws_data = [];
                
                if (type === 'injury') {
                    ws_data.push(['Case Number', 'Date', 'Site', 'Severity', 'Body Part', 'Days Lost', 'Recordable', 'Status']);
                    data.forEach(d => {
                        ws_data.push([
                            d.caseNumber,
                            d.date.toLocaleDateString(),
                            d.site,
                            d.severity,
                            d.bodyPart,
                            d.daysLost,
                            d.recordable ? 'Yes' : 'No',
                            d.status
                        ]);
                    });
                } else {
                    ws_data.push(['ID', 'Date', 'Site', 'Severity', 'Risk Score', 'Location', 'Type', 'Status']);
                    data.forEach(d => {
                        ws_data.push([
                            d.id,
                            d.date.toLocaleDateString(),
                            d.site,
                            d.severity,
                            d.riskScore.toFixed(1),
                            d.location,
                            d.type,
                            d.status
                        ]);
                    });
                }
                
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, type === 'injury' ? 'Injury Data' : 'Near Miss Data');
                
                XLSX.writeFile(wb, `${type}_data_${Date.now()}.xlsx`);
                showStatus('Excel file exported successfully', 'success');
                showLoading(false);
            }, 500);
        }

        // Drag and Drop
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event, type) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    const fakeEvent = { target: { files: [file] } };
                    handleFileUpload(fakeEvent, type);
                } else {
                    showStatus('Please upload a CSV file', 'error');
                }
            }
        }

        // UI Helper Functions
        function showStatus(message, type = 'info') {
            const status = document.createElement('div');
            status.className = `status-message status-${type}`;
            status.textContent = message;
            document.body.appendChild(status);
            
            setTimeout(() => {
                status.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => status.remove(), 300);
            }, 3000);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // Add slideOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
